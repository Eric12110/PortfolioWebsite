<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Noto+Sans+TC&display=swap" rel="stylesheet">
    <title>Contact 聯絡我們</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <!-- EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
    <script src="https://cdn.emailjs.com/dist/email.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <style>
        #EditUploadSection {
            margin: 0 auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
            max-width: 800px;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
        }

        .contact-container {
            margin-top: 60px;
        }

        .form-control::placeholder {
            color: #bbb;
        }

        .form-control:focus {
            box-shadow: none;
            border-color: #86b7fe;
        }

        .btn-send {
            font-weight: bold;
            color: #333;
            text-align: right;
        }

        @media (max-width: 768px) {
            .contact-image {
                margin-bottom: 30px;
            }
        }
    </style>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="headerContainer"></div>
    <div class="container contact-container">
        <h2 class="text-muted" style="margin-left: 15px;">Contact</h2>
        <div class="row">
            <!-- 左邊圖片 -->
            <div class="col-md-6 text-center p-4">
                <img id="ContactImage" src="你的圖片URL" class="img-fluid rounded shadow" alt="服務圖片"
                    style="max-height: 400px; object-fit: cover;">
            </div>
            <!-- 右邊表單 -->
            <div class="col-md-6">
                <div class="col-md-6 p-1">
                    <h2 class="mb-4 fw-bold"></h2>
                    <p id="ContactText" class="editable-text text-muted" style="white-space: pre-wrap;"></p>
                </div>

                <form id="contactForm">
                    <input type="text" name="name" class="form-control mb-2" placeholder="Name *" required />
                    <input type="text" name="email" class="form-control mb-2" placeholder="Email *" required />
                    <input type="tel" name="phone" class="form-control mb-2" placeholder="Phone" />
                    <input type="text" name="facebook" class="form-control mb-2" placeholder="Facebook" required />
                    <input type="text" name="line" class="form-control mb-2" placeholder="Line" required />
                    <textarea name="message" class="form-control mb-3" rows="5" placeholder="Message"
                        required></textarea>
                    <div class="text-end">
                        <button type="submit" class="btn btn-outline-primary">Send</button>
                    </div>
                </form>

                <div id="statusMessage" class="mt-3"></div>
            </div>
        </div>
    </div>
    <div id="EditUploadSection" class="col-md-6 contact-image text-center">
        <!-- 僅登入者能見的圖片上傳 -->
        <div id="uploadSection" style="display: none;">
            <input type="file" id="ContactImageInput" accept="image/*" multiple class="form-control" />
            <!-- 上傳按鈕 -->
            <button id="uploadBtn" onclick="uploadContactImage()" class="btn btn-primary">開始上傳</button>
            <div id="uploadStatus" class="mt-2 text-muted"></div>
            <textarea id="ContactTextInput" class="form-control mb-3" rows="6" placeholder="輸入服務描述..."></textarea>
            <button class="btn btn-success" onclick="saveContactText()">儲存描述</button>
        </div>
    </div>
    <script>
        // ✅ 初始化 Firebase（請填入你的 config）
        const firebaseConfig = {
            apiKey: "AIzaSyBg8EzN4UcX0g1JQ-6rhzSHLu_RD5NIPJA",
            authDomain: "loginregistration-1dba1.firebaseapp.com",
            databaseURL: "https://loginregistration-1dba1.asia-southeast1.firebasedatabase.app",
            projectId: "loginregistration-1dba1",
            storageBucket: "loginregistration-1dba1.firebasestorage.app",
            messagingSenderId: "445119046757",
            appId: "1:445119046757:web:3ee19609f46b8a9b91928c",
            measurementId: "G-FWEP0T45HC"
        };
        firebase.initializeApp(firebaseConfig);
        const storage = firebase.storage();
        const database = firebase.database();
        (function () {
            emailjs.init("1Rph-f4izQkVTFQJX"); // 替換成你的 Public Key
        })();
        document.getElementById("contactForm").addEventListener("submit", function (e) {
            e.preventDefault();

            const statusMsg = document.getElementById("statusMessage");
            statusMsg.innerText = "⏳ 發送中...";

            emailjs.sendForm('service_hquhn8v', 'template_4qzqt7b', "#contactForm")
                .then(function () {
                    statusMsg.innerText = "✅ 郵件已成功送出，感謝您的聯絡！";
                    e.target.reset();
                }, function (error) {
                    console.error("發送失敗", error);
                    statusMsg.innerText = "❌ 發送失敗，請稍後再試一次。";
                });
        });
        // 顯示已上傳資料
        async function loadContactContent() {
            const OWNER_UID = "7YL4JKlCh4M5ekDe9SzwAjXqLb03"; // 你的 UID
            // 等待取得目前登入使用者
            const user = await getCurrentUser();
            const isLoggedIn = user && user.uid === OWNER_UID;

            if (!isLoggedIn) {
                document.getElementById("uploadSection").style.display = "none";
            } else {
                document.getElementById("uploadSection").style.display = "block";
            }
            database.ref("ContactPage").once("value").then(snapshot => {
                const data = snapshot.val();
                if (data?.imageURL) {
                    document.getElementById("ContactImage").src = data.imageURL;
                }
                if (data?.description) {
                    document.getElementById("ContactText").innerText = data.description;
                }
                document.getElementById("ContactTextInput").value = data?.description || "";
            });
        }
        // 上傳圖片
        function uploadContactImage() {
            const fileInput = document.getElementById("ContactImageInput");
            const file = fileInput.files[0];
            if (!file) {
                alert("請選擇一張圖片");
                return;
            }

            const storageRef = storage.ref(`Contact/main_image_${Date.now()}`);
            storageRef.put(file).then(snapshot => snapshot.ref.getDownloadURL()).then(url => {
                database.ref("ContactPage/imageURL").set(url);
                document.getElementById("ContactImage").src = url;
                alert("圖片已上傳並更新！");
                loadContactContent();
            }).catch(err => {
                console.error("圖片上傳失敗", err);
                alert("圖片上傳失敗");
            });
        }
        function getCurrentUser() {
            return new Promise((resolve) => {
                const unsubscribe = firebase.auth().onAuthStateChanged(user => {
                    unsubscribe(); // 監聽到狀態後立即取消監聽
                    resolve(user);
                });
            });
        }
        async function loadAlbumPhotos() {
            const container = document.getElementById('photo-list');
            container.innerHTML = "";
            const OWNER_UID = "7YL4JKlCh4M5ekDe9SzwAjXqLb03"; // 你的 UID
            // 等待取得目前登入使用者
            const user = await getCurrentUser();
            const isLoggedIn = user && user.uid === OWNER_UID;

            if (!isLoggedIn) {
                document.getElementById("uploadSection").style.display = "none";
            } else {
                document.getElementById("uploadSection").style.display = "block";
            }
            // 這裡改為讀取 Contact 下所有照片
            firebase.database().ref('Contact').once('value').then(snapshot => {
                if (!snapshot.exists()) {
                    container.innerHTML = "<p class='text-muted'>找不到任何照片。</p>";
                    return;
                }
                const photos = [];

                snapshot.forEach(photoSnap => {
                    const key = photoSnap.key;
                    const data = photoSnap.val();

                    // 沒有 order 預設為 0
                    photos.push({ key, order: data.order || 0, ...data });
                });

                // 依 order 排序
                photos.sort((a, b) => a.order - b.order);

                photos.forEach(photo => {
                    const col = document.createElement("div");
                    col.className = "col-md-4 col-sm-6";
                    col.setAttribute("data-id", photo.key);

                    col.innerHTML = `
                    <div class="resizable draggable" style="width: 100%; max-width: 100%; height: auto; display: inline-block; position: relative;">
                    <img src="${photo.url}" class="card-img-top img-fluid" style="height: 300px; object-fit: cover;">
                    </div>
                    ${photo.description === undefined ? "" : `<div class="card-body text-center p-2"><p class="card-text">${photo.description}</p>`}
                    ${isLoggedIn ? `
                        <button class="btn btn-danger btn-sm" onclick="deletePhoto('${photo.key}')">刪除</button>
                    ` : ""}
                    </div>
            `;

                    container.appendChild(col);
                });

                if (isLoggedIn) {
                    Sortable.create(container, {
                        animation: 150
                    });
                }
            });
        }
        //刪除照片
        window.deletePhoto = function (photoId) {
            if (confirm("確定要刪除這張照片？")) {
                database.ref(`Contact/${photoId}`).remove();
                alert("照片已刪除");
                loadContactContent();
            }
        }

        loadContactContent();

        fetch('header.html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('headerContainer').innerHTML = html;
            })
            .catch(err => {
                console.error('載入 header 失敗', err);
            });
        // 儲存文字
        function saveContactText() {
            const newText = document.getElementById("ContactTextInput").value;
            database.ref("ContactPage/description").set(newText).then(() => {
                document.getElementById("ContactText").innerText = newText;
                alert("描述已儲存！");
            }).catch(err => {
                console.error("描述儲存失敗", err);
                alert("儲存失敗");
            });
        }
    </script>
</body>

</html>