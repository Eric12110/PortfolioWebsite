<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>相簿瀏覽</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Noto+Sans+TC&display=swap" rel="stylesheet">
    <style>
        /* body {
            font-family: "Noto Sans TC", "Helvetica Neue", Helvetica, Arial, sans-serif;
            margin: 40px;
            color: #111;
            background: #fff;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        } */

        .container {
            display: flex;
            gap: 60px;
            flex-wrap: wrap;
            margin-top: 20px;
            max-width: 800px;
        }

        .left {
            flex: 1 1 40%;
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .left img {
            width: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        .left .title {
            font-style: italic;
            font-weight: 400;
            font-size: 24px;
            line-height: 1.3;
            font-family: "Georgia", serif;
            color: #222;
        }

        .right {
            flex: 1 1 55%;
            font-size: 16px;
            line-height: 1.7;
            white-space: pre-line;
        }

        .right strong {
            font-weight: 700;
        }

        .right em {
            font-style: italic;
        }

        /* 編輯區 */
        #editSection {
            margin: 0 auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
            max-width: 800px;
        }

        #uploadedImages {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
        }

        .image-item {
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 8px;
            width: 180px;
            text-align: center;
        }

        .image-item img {
            max-width: 100%;
            border-radius: 4px;
        }

        .desc-input {
            width: 100%;
            margin-top: 8px;
            font-size: 14px;
        }

        button.save-desc {
            margin-top: 6px;
            padding: 4px 8px;
            font-size: 14px;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                gap: 40px;
            }

            .left,
            .right {
                flex: none;
                width: 100%;
            }
        }

        #headerContainer {
            width: 100%;
        }

        .p0 {
            font-size: 20px;
            line-height: 1.5;
            color: #333;
            text-align: center;
            font-family: 'Times New Roman', Times, serif;
        }
    </style>
</head>

<body>
    <div id="headerContainer"></div>
    <div class="container">
        <div id="photoGallery">
            <!-- 照片會由 JS 載入 -->
        </div>
    </div>

    <!-- 編輯區（登入使用者可見） -->
    <div id="editSection" style="display:none;">
        <h3>圖片管理與上傳</h3>
        <input type="file" id="fileInput" accept="image/*" />
        <button onclick="uploadImage()">上傳圖片</button>

        <div id="uploadedImages"></div>
    </div>

    <!-- Firebase 8.x SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- interact.js -->
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <script>
        fetch('header.html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('headerContainer').innerHTML = html;
            })
            .catch(err => {
                console.error('載入 header 失敗', err);
            });
        // Firebase config 請換成你自己的
        const firebaseConfig = {
            apiKey: "AIzaSyBg8EzN4UcX0g1JQ-6rhzSHLu_RD5NIPJA",
            authDomain: "loginregistration-1dba1.firebaseapp.com",
            databaseURL: "https://loginregistration-1dba1.asia-southeast1.firebasedatabase.app",
            projectId: "loginregistration-1dba1",
            storageBucket: "loginregistration-1dba1.firebasestorage.app",
            messagingSenderId: "445119046757",
            appId: "1:445119046757:web:3ee19609f46b8a9b91928c",
            measurementId: "G-FWEP0T45HC"
        };

        // 初始化
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage();

        // 你的管理者 UID (要改成你的 Firebase Authentication 使用者 uid)
        const OWNER_UID = "7YL4JKlCh4M5ekDe9SzwAjXqLb03";

        // DOM 元素
        const editSection = document.getElementById("editSection");
        const fileInput = document.getElementById("fileInput");
        const uploadedImages = document.getElementById("uploadedImages");
        const photoGallery = document.getElementById("photoGallery");

        // 監聽登入狀態，決定是否顯示編輯區
        auth.onAuthStateChanged(user => {
            if (user && user.uid === OWNER_UID) {
                editSection.style.display = "block";
                loadImages();
            } else {
                editSection.style.display = "none";
                loadImages();
            }
        });

        // 上傳圖片並存資料到 Realtime Database
        function uploadImage() {
            const file = fileInput.files[0];
            if (!file) {
                alert("請先選擇圖片");
                return;
            }
            const storageRef = storage.ref(`aboutMe/${Date.now()}_${file.name}`);
            const uploadTask = storageRef.put(file);

            uploadTask.on(
                "state_changed",
                snapshot => {
                    // 可做上傳進度顯示
                },
                error => {
                    console.error("上傳失敗", error);
                    alert("圖片上傳失敗");
                },
                () => {
                    uploadTask.snapshot.ref.getDownloadURL().then(url => {
                        // 新增圖片資料到 database，包含 url 和空描述
                        const newImageRef = database.ref("aboutMe").push();
                        newImageRef.set({
                            url: url,
                            description: ""
                        }).then(() => {
                            alert("圖片上傳成功");
                            fileInput.value = "";
                            loadImages();
                        });
                    });
                }
            );
        }
        let count = 0;
        // 載入資料庫圖片資料並顯示
        function loadImages() {
            uploadedImages.innerHTML = "";
            photoGallery.innerHTML = "";

            database.ref("aboutMe").once("value").then(snapshot => {
                const photos = snapshot.val();
                if (!photos) return;

                Object.entries(photos).forEach(([key, photo], index) => {
                    // -----------------
                    // 後台管理項目
                    // -----------------
                    const div = document.createElement("div");
                    div.className = "image-item";

                    const img = document.createElement("img");
                    img.src = photo.url;
                    img.alt = photo.description || "圖片";
                    img.style.width = "200px"; // 讀取存的寬度
                    img.style.height = "auto";

                    const input = document.createElement("input");
                    input.type = "text";
                    input.className = "desc-input";
                    input.placeholder = "輸入描述";
                    input.value = photo.description || "";

                    const saveBtn = document.createElement("button");
                    saveBtn.className = "save-desc";
                    saveBtn.textContent = "儲存描述";

                    saveBtn.addEventListener("click", () => {
                        database.ref(`aboutMe/${key}/description`).set(input.value)
                            .then(() => {
                                Swal.fire("成功", "描述已儲存", "success");
                                loadImages();
                            })
                            .catch(err => {
                                console.error(err);
                                Swal.fire("錯誤", "儲存失敗", "error");
                            });
                    });

                    // 刪除按鈕
                    const deleteBtn = document.createElement("button");
                    deleteBtn.textContent = "刪除";
                    deleteBtn.style.background = "red";
                    deleteBtn.style.color = "white";

                    deleteBtn.addEventListener("click", () => {
                        Swal.fire({
                            title: "確定要刪除嗎？",
                            text: "刪除後將無法恢復",
                            icon: "warning",
                            showCancelButton: true,
                            confirmButtonText: "刪除",
                            cancelButtonText: "取消"
                        }).then(result => {
                            if (result.isConfirmed) {
                                database.ref(`aboutMe/${key}`).remove()
                                    .then(() => {
                                        Swal.fire("已刪除", "", "success");
                                        loadImages();
                                    })
                                    .catch(err => {
                                        console.error(err);
                                        Swal.fire("錯誤", "刪除失敗", "error");
                                    });
                            }
                        });
                    });
                    div.appendChild(img);
                    div.appendChild(input);
                    div.appendChild(saveBtn);
                    div.appendChild(deleteBtn);
                    uploadedImages.appendChild(div);

                    // -----------------
                    // 前台展示（偶數/奇數交錯）
                    // -----------------
                    const row = document.createElement("div");
                    row.className = "row";
                    row.style.display = "flex";
                    row.style.alignItems = "center";
                    row.style.marginBottom = "20px";

                    const textCol = document.createElement("div");
                    textCol.style.flex = "1";
                    textCol.innerHTML = `<p class="p${count}">${photo.description || ""}</p>`;

                    const imgCol = document.createElement("div");
                    imgCol.style.flex = "1";

                    const displayImg = document.createElement("img");
                    displayImg.src = photo.url;
                    displayImg.style.width = photo.width || "300px";
                    displayImg.style.height = photo.height || "auto";
                    displayImg.className = "resizable"; // 用於 interact.js
                    displayImg.dataset.key = key; // 存 Firebase key

                    imgCol.appendChild(displayImg);

                    if (index % 2 === 0) {
                        row.appendChild(textCol);
                        row.appendChild(imgCol);
                    } else {
                        row.appendChild(imgCol);
                        row.appendChild(textCol);
                    }

                    photoGallery.appendChild(row);
                    count++;
                });

                // 啟用 interact.js 調整大小
                interact(".resizable").resizable({
                    edges: { left: true, right: true, bottom: true, top: true }
                }).on("resizemove", event => {
                    let target = event.target;
                    target.style.width = event.rect.width + "px";
                    target.style.height = event.rect.height + "px";
                }).on("resizeend", event => {
                    let target = event.target;
                    let key = target.dataset.key;
                    let width = target.style.width;
                    let height = target.style.height;

                    // 儲存到 Firebase
                    database.ref(`aboutMe/${key}`).update({ width, height })
                        .then(() => {
                            console.log("已儲存圖片大小", width, height);
                        })
                        .catch(err => console.error(err));
                });
            });
        }
    </script>
</body>

</html>